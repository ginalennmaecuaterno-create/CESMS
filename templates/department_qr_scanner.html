{% extends "base_department.html" %}

{% block title %}QR Scanner - Department Panel{% endblock %}

{% block content %}
<!-- Premium Header -->
<div class="bg-white border-b border-gray-200 py-8 sm:py-12 lg:py-16 px-4 sm:px-6 lg:px-8 mb-8 sm:mb-12">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-light mb-2 sm:mb-4 tracking-tight text-gray-900">QR Code Scanner</h1>
    <p class="text-base sm:text-lg lg:text-xl text-gray-600">Scan student QR codes to mark attendance</p>
  </div>
</div>

<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pb-8 sm:pb-12 lg:pb-16">
  {% if not events %}
  <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 sm:p-6 mb-6 sm:mb-8">
    <div class="flex items-start gap-3">
      <svg class="w-6 h-6 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
      </svg>
      <div>
        <p class="text-sm sm:text-base text-yellow-800 font-semibold">No ongoing events available for scanning.</p>
        <p class="text-sm text-yellow-700 mt-2">QR scanning is only available for events that are currently happening (Ongoing status).</p>
        <p class="text-xs text-yellow-600 mt-1">Events become "Ongoing" when the current time is within the event's scheduled time range.</p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Event Selection -->
  <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 lg:p-8 shadow-sm border border-gray-100 mb-6 sm:mb-8">
    <label for="event-select" class="block text-sm sm:text-base font-semibold text-gray-900 mb-3 sm:mb-4">Select Event (Ongoing only)</label>
    <select id="event-select" 
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base"
            {% if not events %}disabled{% endif %}>
      <option value="">-- Select an event --</option>
      {% for event in events %}
      <option value="{{ event.id }}">
        {{ event.event_name }} - {{ event.date }}
        {% if event.display_status == 'Ongoing' %}(ONGOING){% endif %}
      </option>
      {% endfor %}
    </select>
  </div>

  <!-- Scanner Container -->
  <div id="scanner-container" style="display: none;">
    <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 lg:p-8 shadow-sm border border-gray-100 mb-6 sm:mb-8">
      <div id="reader" class="w-full max-w-2xl mx-auto mb-6"></div>
      
      <div id="scan-result" class="hidden mb-6"></div>
      
      <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center">
        <button id="start-scan-btn" 
                onclick="startScanning()" 
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl transition-all duration-300 text-sm sm:text-base font-semibold">
          Start
        </button>
        <button id="stop-scan-btn" 
                onclick="stopScanning()" 
                style="display: none;"
                class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-xl transition-all duration-300 text-sm sm:text-base font-semibold">
          Stop
        </button>
      </div>
    </div>
  </div>

</div>

<!-- Include HTML5 QR Code Scanner Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
let html5QrcodeScanner = null;
let selectedEventId = null;

document.getElementById('event-select').addEventListener('change', function() {
  selectedEventId = this.value;
  if (selectedEventId) {
    document.getElementById('scanner-container').style.display = 'block';
  } else {
    document.getElementById('scanner-container').style.display = 'none';
    stopScanning();
  }
});

function startScanning() {
  if (!selectedEventId) {
    showAlertModal('Please select an event first', 'yellow');
    return;
  }
  
  document.getElementById('start-scan-btn').style.display = 'none';
  document.getElementById('stop-scan-btn').style.display = 'inline-block';
  
  html5QrcodeScanner = new Html5Qrcode("reader");
  
  html5QrcodeScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    onScanSuccess,
    onScanError
  ).catch(err => {
    console.error('Error starting scanner:', err);
    showAlertModal('Error starting camera. Please check permissions or use manual entry.', 'red');
    stopScanning();
  });
}

function stopScanning() {
  if (html5QrcodeScanner) {
    html5QrcodeScanner.stop().then(() => {
      html5QrcodeScanner = null;
      document.getElementById('start-scan-btn').style.display = 'inline-block';
      document.getElementById('stop-scan-btn').style.display = 'none';
    }).catch(err => {
      console.error('Error stopping scanner:', err);
    });
  }
}

function onScanSuccess(decodedText, decodedResult) {
  stopScanning();
  verifyQRCode(decodedText);
}

function onScanError(errorMessage) {
  // Ignore scan errors
}

function verifyQRCode(uniqueCode) {
  fetch('{{ url_for("attendance.verify_qr") }}', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ unique_code: uniqueCode, event_id: selectedEventId })
  })
  .then(response => response.json())
  .then(data => {
    const resultDiv = document.getElementById('scan-result');
    resultDiv.classList.remove('hidden');
    
    if (data.success) {
      resultDiv.className = 'p-6 rounded-xl bg-green-50 border-2 border-green-500 text-center';
      resultDiv.innerHTML = `
        <h2 class="text-2xl font-bold text-green-800 mb-4">Success!</h2>
        <div class="text-left space-y-2">
          <p class="text-gray-700"><strong>Name:</strong> ${data.student.name}</p>
          <p class="text-gray-700"><strong>Student ID:</strong> ${data.student.student_id}</p>
          <p class="text-gray-700"><strong>Email:</strong> ${data.student.email}</p>
        </div>
        <p class="mt-4 text-green-700 font-semibold">Attendance marked successfully!</p>
      `;
      setTimeout(() => {
        resultDiv.classList.add('hidden');
        startScanning();
      }, 3000);
    } else {
      if (data.already_attended) {
        resultDiv.className = 'p-6 rounded-xl bg-yellow-50 border-2 border-yellow-500 text-center';
        resultDiv.innerHTML = `
          <h2 class="text-2xl font-bold text-yellow-800 mb-4">Already Checked In</h2>
          <p class="text-gray-700">${data.message}</p>
          ${data.student ? `
            <div class="mt-4 text-left space-y-2">
              <p class="text-gray-700"><strong>Name:</strong> ${data.student.full_name || data.student.name || 'N/A'}</p>
              <p class="text-gray-700"><strong>Student ID:</strong> ${data.student.student_id || 'N/A'}</p>
              <p class="text-gray-700"><strong>Email:</strong> ${data.student.email || 'N/A'}</p>
            </div>
          ` : ''}
        `;
      } else {
        resultDiv.className = 'p-6 rounded-xl bg-red-50 border-2 border-red-500 text-center';
        resultDiv.innerHTML = `
          <h2 class="text-2xl font-bold text-red-800 mb-4">Error</h2>
          <p class="text-gray-700">${data.message}</p>
        `;
      }
      setTimeout(() => {
        resultDiv.classList.add('hidden');
        startScanning();
      }, 2000);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    const resultDiv = document.getElementById('scan-result');
    resultDiv.classList.remove('hidden');
    resultDiv.className = 'p-6 rounded-xl bg-red-50 border-2 border-red-500 text-center';
    resultDiv.innerHTML = `
      <h2 class="text-2xl font-bold text-red-800 mb-4">Error</h2>
      <p class="text-gray-700">Failed to verify QR code. Please try again.</p>
    `;
    setTimeout(() => {
      resultDiv.classList.add('hidden');
      startScanning();
    }, 2000);
  });
}

window.addEventListener('beforeunload', () => {
  stopScanning();
});
</script>

{% endblock %}
